<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Simplex Send Demo</title>
    <meta name="description" content="DisplaySocket.js simplex send demo" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      @media screen and (min-width: 850px) {
        #queueList {
          position: absolute;
          top: 1rem;
          right: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <button onclick="displaySocket.nextVideoSource();">Next camera</button>
    <input id="file-input" type="file" />
    <div id="toolbars" style="display: none">
      <input type="text" placeholder="sliceSize" id="sliceSize" value="250" />
      <input type="text" placeholder="interval" id="interval" value="30" />
      <span>Number of slices <span id="sliceCount">0</span></span>
      <select id="batch"></select>
    </div>
    <script src="../dist/displaysocket.js"></script>
    <div style="margin: 15px; background: black" id="writer-output"></div>
    <div id="queueList">
      <textarea name="" id="pending" cols="30" rows="10"></textarea>
    </div>
    <script>
      /*
        // shake the output to prevent getting stuck when camera not moving
        var outputElement = document.getElementById('writer-output');
        setInterval(function() {
            var a = 20;
            outputElement.style.marginLeft = 5 + (Math.random() + a) + 'px';
            outputElement.style.marginTop  = 5 + (Math.random() + a) + 'px';
        }, 100);
        */
    </script>
    <script>
      var outputElement = document.getElementById("writer-output");
      var size = Math.min(window.innerHeight, window.innerWidth);
      console.log("sizes", window.innerHeight, window.innerWidth);
      size -= parseInt(outputElement.style.margin) * 4;
      console.log("size:", size);
      outputElement.style.width = size + "px";
      outputElement.style.height = size + "px";
      var fileInput = document.getElementById("file-input");
      var displaySocket = new DisplaySocket({
        output: outputElement,
      });
      var batch = document.getElementById("batch");
      displaySocket.addEventListener("sliceCountChange", function (slice) {
        document.getElementById("sliceCount").innerText = slice;
        slice *= 1;
        var batchCount = slice / 100; //Batch size of 100 each.
        batch.innerHTML = "<option value=0>All</option>";
        for (let i = 0; i < batchCount; i++) {
          var option = document.createElement("option");
          var label = `${i * 100 + 1}-${Math.min((i + 1) * 100, slice)}`;
          option.appendChild(document.createTextNode(label));
          option.setAttribute("value", label);
          batch.appendChild(option);
        }
        document.getElementById("toolbars").style.display = "inline";
      });

      /*
        // handy if you don't want to select a file every time
        var sendData = '';
        for(var i = 0; i < 100; i++) {
            sendData += i + ' ';
        }
        displaySocket.send(sendData);
        /**/

      fileInput.addEventListener("change", function (e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          displaySocket.send(reader.result, file.name);
        };
      });
      document
        .getElementById("sliceSize")
        .addEventListener("change", function (e) {
          displaySocket.stop();
          displaySocket.setSlice(parseInt(e.target.value));
          fileInput.dispatchEvent(new Event("change"));
        });
      document
        .getElementById("interval")
        .addEventListener("change", function (e) {
          displaySocket.setInterval(parseInt(e.target.value));
        });
      document
        .getElementById("pending")
        .addEventListener("change", function (e) {
          displaySocket.setQueue(e.target.value);
        });
      batch.addEventListener("change", function (e) {
        // displaySocket.setBatch(e.target.value);
        console.log(e.target.value);
        let op = "";
        if (e.target.value != 0) {
          var [start, end] = e.target.value.split("-");
          start--;
          end--;
          for (let i = start; i < end; i++) {
            op += i + ",";
          }
        }
        displaySocket.setQueue(op);
      });
    </script>
  </body>
</html>
